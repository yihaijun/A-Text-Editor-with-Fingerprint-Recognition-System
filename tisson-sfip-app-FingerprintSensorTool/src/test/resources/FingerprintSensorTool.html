<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>指纹采集校验</title>
    <style>
        p{
            width:0px;
            height:40px;
            border-radius:16px;
            background:#09f;
            text-align:center;
            font:bold 16px/24px '微软雅黑';
            color:white;
        }
    </style>
    <script>
        window.onload = function(){
            var cmdEnroll = document.querySelector( "#cmdEnroll" ),
            	cmdIdentify = document.querySelector( "#cmdIdentify" ),
            	cmdVerify = document.querySelector( "#cmdVerify" ),
            	cmdTxtVerify = document.querySelector( "#cmdTxtVerify" ),
            	barEnrollProgress = document.querySelector( "#barEnrollProgress" ),
            	cmdTimer = null, cmdEnrollProgressBarValue = 0,
            	getCmdPromptTimer = null,
            	httpLoad = null,httpGetCmdPrompt=null,
            	sfipHome="",
                searchStr = location.search,searchStr,searchs,address;  
            
            if(searchStr.length>1){
            	searchStr = searchStr.substr(1);
            	searchs = searchStr.split("&");
            	if(searchs[0].indexOf("=")>0){ 
            		address = searchs[0].split("=");
            		document.getElementById("cmdInput").value=address[1];
            	}    
            }

            getCmdPromptTimer = setInterval( function(){
            	document.getElementById("fingerprintBmp").src="file:///"+sfipHome+"/fingerprint/fingerprint.bmp";
            }, 800 );
            
            if(window.ActiveXObject){
				try {
					httpLoad = new ActiveXObject("Msxml2.XMLHTTP");
				} catch (e) {
					try {
						httpLoad = new ActiveXObject("Microsoft.XMLHTTP");
					} catch (e) {
					}
				}
			}else if (window.XMLHttpRequest){
				httpLoad=new XMLHttpRequest();
			}else if (window.ActiveXObject){
				httpLoad=new ActiveXObject("Microsoft.XMLHTTP");
			}
            httpLoad.onload = function(e) {};
            httpLoad.ontimeout = function(e) {};
            httpLoad.onerror = function(e) {};
            //httpLoad.upload.onprogress = function(e) {};
            httpLoad.onreadystatechange = function(e) {
				if(this.status == 200||this.status == 304){
					document.getElementById("infFingerprintSensor").value=this.responseText;
						pos=this.responseText.indexOf("SfipHome=")+9;
						len =this.responseText.indexOf("\",\"responseCode\":\"")-pos;
						sfipHome=this.responseText.substr(pos,len);
						while(sfipHome.indexOf("\\\\")>=0){
							sfipHome=sfipHome.replace("\\\\","/");
						}
						sfipHome=sfipHome;
				}
			};
			httpLoad.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
			httpLoad.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
        	httpLoad.timeout = 50000;
        	httpLoad.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
			httpLoad.send("{\"appName\":\"\",\"beanName\":\"load\",\"msg\":\"\"}");
			
           	getStyle = function( obj, name, value ){
                   if( obj.currentStyle ) {
                       return obj.currentStyle[name];
                   }else {
                       return getComputedStyle( obj, false )[name];
                   }
               };
               
			cmdEnroll.onclick = function(){
				document.getElementById("cmdPrompt").value="请你按同一个手指三次!";
				clearInterval( cmdTimer );
				var xmlhttp=null;
				xmlhttp=new XMLHttpRequest();
	            xmlhttp.onload = function(e) {};
	            xmlhttp.ontimeout = function(e) {};
	            xmlhttp.onerror = function(e) {};
	            //xmlhttp.upload.onprogress = function(e) {};
	            xmlhttp.onreadystatechange = function(e) {
					if(this.status == 200||this.status == 304){
					}
				};
				xmlhttp.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
				xmlhttp.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
	        	xmlhttp.timeout = 50000;
	        	xmlhttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
				xmlhttp.send("{\"appName\":\"\",\"beanName\":\"cmdEnroll\",\"msg\":\""+document.getElementById("cmdInput").value+"\"}");

				
               	barEnrollProgress.style.width = '0';
               	cmdTimer = setInterval( function(){
               		cmdEnrollProgressBarValue = parseInt( getStyle( barEnrollProgress, 'width' ) );
                   	if ( cmdEnrollProgressBarValue < 500 ) {
   	                    httpGetCmdPrompt=new XMLHttpRequest();
   	    	            httpLoad.onload = function(e) {};
   	    	            httpLoad.ontimeout = function(e) {};
   	    	            httpLoad.onerror = function(e) {};
   	    	            //httpLoad.upload.onprogress = function(e) {};
   	    	            httpLoad.onreadystatechange = function(e) {
   	    					if(this.status == 200||this.status == 304){
   	    						document.getElementById("cmdPrompt").value=this.responseText;
//   	                   		barEnrollProgress.style.width = barEnrollProgress.offsetWidth + 10 + 'px';
//   	                    	barEnrollProgress.innerHTML = parseInt( getStyle( barEnrollProgress, 'width' ) ) / 5 + '%';
                                if(this.responseText.indexOf("please press the same finger 3 times for the enrollment")>=0){
                                	barEnrollProgress.style.width = '50px'
                                	barEnrollProgress.innerHTML = '10%'
                                }else if(this.responseText.indexOf("You need to press the 2 times fingerprint")>=0){
                                	barEnrollProgress.style.width = (33 * 5) +'px'
                                    barEnrollProgress.innerHTML = '33%'
                                }else if(this.responseText.indexOf("You need to press the 1 times fingerprint")>=0){
                                	barEnrollProgress.style.width = (33 * 5 *2) +'px'
                                    barEnrollProgress.innerHTML = '66%'
                                }else if(this.responseText.indexOf("enroll succ")>=0){
                                	barEnrollProgress.style.width = '500px'
                                    barEnrollProgress.innerHTML = '100%'
                        			clearInterval( cmdTimer );
    								var xmlhttp2=null;
    								xmlhttp2=new XMLHttpRequest();
    					            xmlhttp2.onload = function(e) {};
    					            xmlhttp2.ontimeout = function(e) {};
    					            xmlhttp2.onerror = function(e) {};
    					            //xmlhttp.upload.onprogress = function(e) {};
    					            xmlhttp2.onreadystatechange = function(e) {
    									if(this.status == 200||this.status == 304){
    									    var pos,len;
    										pos=this.responseText.indexOf("\"result\":\"")+11;
    										len =this.responseText.indexOf("\",\"responseCode\":\"")-pos;
    										document.getElementById("cmdResult").value=this.responseText.substr(pos,len);
    									}
    								};
    								xmlhttp2.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
    								xmlhttp2.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
    					        	xmlhttp2.timeout = 50000;
    					        	xmlhttp2.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
    								xmlhttp2.send("{\"appName\":\"\",\"beanName\":\"getCurrentOwnerRegTempBase64\",\"msg\":\"\"}");
                                }
   	    					}
   	    				};
   	    				httpLoad.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
   	    				httpLoad.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
   	    	        	httpLoad.timeout = 50000;
   	    	        	httpLoad.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
   	    				httpLoad.send("{\"appName\":\"\",\"beanName\":\"getCmdPrompt\",\"msg\":\"\"}");
                   	}
               	}, 1000 );
           	}
           
			cmdIdentify.onclick = function(){
				clearInterval( cmdTimer );
				var xmlhttp=null;
				xmlhttp=new XMLHttpRequest();
	            xmlhttp.onload = function(e) {};
	            xmlhttp.ontimeout = function(e) {};
	            xmlhttp.onerror = function(e) {};
	            //xmlhttp.upload.onprogress = function(e) {};
	            xmlhttp.onreadystatechange = function(e) {
					if(this.status == 200||this.status == 304){
					}
				};
				xmlhttp.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
				xmlhttp.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
	        	xmlhttp.timeout = 50000;
	        	xmlhttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
				xmlhttp.send("{\"appName\":\"\",\"beanName\":\"cmdIdentify\",\"msg\":\"\"}");

   				cmdTimer = setInterval( function(){
                    httpGetCmdPrompt=new XMLHttpRequest();
    	            httpLoad.onload = function(e) {};
    	            httpLoad.ontimeout = function(e) {};
    	            httpLoad.onerror = function(e) {};
    	            //httpLoad.upload.onprogress = function(e) {};
    	            httpLoad.onreadystatechange = function(e) {
    					if(this.status == 200||this.status == 304){
    						document.getElementById("cmdPrompt").value=this.responseText;
							if(this.responseText.indexOf("Identify suc")>=0  || this.responseText.indexOf("Identify fail")>=0 ){
								clearInterval( cmdTimer );
							}
							if(this.responseText.indexOf("Identify suc") >=0 ){
								var xmlhttp=null;
								xmlhttp=new XMLHttpRequest();
					            xmlhttp.onload = function(e) {};
					            xmlhttp.ontimeout = function(e) {};
					            xmlhttp.onerror = function(e) {};
					            //xmlhttp.upload.onprogress = function(e) {};
					            xmlhttp.onreadystatechange = function(e) {
									if(this.status == 200||this.status == 304){
									    var pos,len;
										pos=this.responseText.indexOf("\"result\":\"")+11;
										len =this.responseText.indexOf("\",\"responseCode\":\"")-pos;
										document.getElementById("cmdResult").value=this.responseText.substr(pos,len);
									}
								};
								xmlhttp.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
								xmlhttp.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
					        	xmlhttp.timeout = 50000;
					        	xmlhttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
								xmlhttp.send("{\"appName\":\"\",\"beanName\":\"getCurrentOwner\",\"msg\":\"\"}");
							}
    					}
    				};
    				httpLoad.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
    				httpLoad.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
    	        	httpLoad.timeout = 50000;
    	        	httpLoad.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
    				httpLoad.send("{\"appName\":\"\",\"beanName\":\"getCmdPrompt\",\"msg\":\"\"}");
               	}, 1000 );
			}

			cmdVerify.onclick = function(){
				clearInterval( cmdTimer );
				var xmlhttp=null;
				xmlhttp=new XMLHttpRequest();
	            xmlhttp.onload = function(e) {};
	            xmlhttp.ontimeout = function(e) {};
	            xmlhttp.onerror = function(e) {};
	            //xmlhttp.upload.onprogress = function(e) {};
	            xmlhttp.onreadystatechange = function(e) {
					if(this.status == 200||this.status == 304){
						document.getElementById("cmdPrompt").value=this.responseText;
						//document.getElementById("cmdResult").value=this.responseText.substr(this.responseText.indexOf("\"result\":\"")+11,this.responseText.indexOf("\",\"responseCode\":\""));
						pos=this.responseText.indexOf("\"result\":\"")+11;
						len =this.responseText.indexOf("\",\"responseCode\":\"")-pos;
						document.getElementById("cmdResult").value=this.responseText.substr(pos,len);
					}
				};
				xmlhttp.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
				xmlhttp.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
	        	xmlhttp.timeout = 50000;
	        	xmlhttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
	        	var inParam=
	        		"{\"appName\":\"\",\"beanName\":\"cmdVerify\",\"msg\":\""+document.getElementById("cmdInput").value+"\"}";
	        	console.log(inParam);
				xmlhttp.send(inParam);
			}
        
			cmdTxtVerify.onclick = function(){
				clearInterval( cmdTimer );
				var xmlhttp=null;
				xmlhttp=new XMLHttpRequest();
	            xmlhttp.onload = function(e) {};
	            xmlhttp.ontimeout = function(e) {};
	            xmlhttp.onerror = function(e) {};
	            //xmlhttp.upload.onprogress = function(e) {};
	            xmlhttp.onreadystatechange = function(e) {
					if(this.status == 200||this.status == 304){
						document.getElementById("cmdPrompt").value=this.responseText;
						//document.getElementById("cmdResult").value=this.responseText.substr(this.responseText.indexOf("\"result\":\"")+11,this.responseText.indexOf("\",\"responseCode\":\""));
						pos=this.responseText.indexOf("\"result\":\"")+11;
						len =this.responseText.indexOf("\",\"responseCode\":\"")-pos;
						document.getElementById("cmdResult").value=this.responseText.substr(pos,len);
					}
				};
				xmlhttp.onerror = function(e) { document.getElementById("infFingerprintSensor").value=e; };
				xmlhttp.open("POST","http://127.0.0.1:29093/services/sfip-management/HellWordBeanSfipDubboInterface/helloWord",true);
	        	xmlhttp.timeout = 50000;
	        	xmlhttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
				xmlhttp.send("{\"appName\":\"\",\"beanName\":\"cmdTxtVerify\",\"msg\":\""+document.getElementById("cmdInput").value+"\"}");
			}
        }
 		  </script>
</head>
<body>
    <input id="cmdEnroll" type="button" style="widh:8px;height:20px" value="指纹录入"/> 
    <input id="cmdIdentify" type="button" style="widh:8px;height:20px" value="快速查询"/> 
    <input id="cmdVerify" type="button" style="widh:8px;height:20px" value="图像查询"/>
    <input id="cmdTxtVerify" type="button" style="widh:8px;height:20px" value="文本查询"/>
    <input id="cmdReturn" type="button" style="widh:8px;height:20px" value="返回"  onclick="javascript:history.back(-1);"/>
    <br/><br/>
    <h>操作提示: </h><h><input type="text" id="cmdPrompt"  style="widh:16px;height:16px" size="80" value="请按手指!"></input></h>
    <br/>
    <h>操作参数: </h><h><input type="text" id="cmdInput"  style="widh:16px;height:16px" size="80" value=""></input></h>
    <br/>
    <h>操作结果: </h><h><input type="text" id="cmdResult"  style="widh:16px;height:16px" size="80" value=""></input></h>
    <br/>
   	<h>错误信息: </h><h><input type="text" id="cmdError"  style="widh:16px;height:16px" size="80" value=""></input></h>
    <br/><h>当前指纹: <img id="fingerprintBmp" src="file:///"+sfipHome+"/fingerprint/fingerprint-blank.bmp"  alt="当前指纹" />
	<p id="barEnrollProgress"></p>
   	<h>设备信息: </h><h><input type="textarea" id="infFingerprintSensor"  style="widh:16px;height:16px" size="80" value=""></input></h>
</body>
</html>